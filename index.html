<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mr. Electric SOP Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="MRE-Bulb-Icon-RGB-FullColor-0518-01-152x152-8200955.jpg" />
  <style>
    :root{
      --primary-blue:#0078d4; --primary-yellow:#f4b400; --dark:#1e1e1e; --light:#f3f3f3;
      --danger:#ef4444; --ok:#10b981; --shadow:0 4px 12px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box} body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:#f6f7fb;color:#222}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .header{background:#fff;border-radius:12px;box-shadow:var(--shadow);padding:12px 16px;margin:12px 0}
    .hrow{display:flex;align-items:center;gap:12px}
    .hrow img.logo{width:44px;height:44px;border-radius:8px;object-fit:cover}
    .hrow h1{font-size:20px;margin:0;color:var(--primary-blue)}
    .spacer{flex:1}
    button{background:var(--primary-blue);color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer}
    button.secondary{background:#e9eef6;color:#1e293b}
    button.warn{background:#f59e0b}
    button.danger{background:#ef4444}
    button:disabled{opacity:.6;cursor:not-allowed}
    .grid{display:grid;grid-template-columns:1fr 1fr; gap:16px}
    .card{background:#fff;border-radius:12px;box-shadow:var(--shadow);padding:16px}
    .card h2,.card h3{display:flex;align-items:center;gap:10px;margin:0 0 12px}
    /* icon fix */
    .card-icon{width:32px;height:32px;min-width:32px;display:grid;place-items:center;background:var(--primary-yellow);border-radius:8px;font-size:18px;line-height:1}
    .stats{display:grid;grid-template-columns:repeat(4,minmax(0,1fr)); gap:12px}
    .stat{background:#fff;border-radius:10px;box-shadow:var(--shadow);padding:14px;text-align:center}
    .stat .num{font-weight:800;color:var(--primary-blue);font-size:24px}
    .list{display:flex;flex-direction:column;gap:10px;max-height:380px;overflow:auto}
    .item{display:flex;gap:10px;align-items:center;justify-content:space-between;border:1px solid #e6e8ee;padding:12px;border-radius:10px;background:#fff}
    .badge{font-size:12px;border-radius:999px;padding:4px 10px}
    .active{background:#d1fae5;color:#065f46}.revoked{background:#fee2e2;color:#991b1b}
    .muted{color:#64748b;font-size:13px}
    .login, .screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:16px}
    .card.center{max-width:420px;width:100%}
    .center .logoTop{width:92px;display:block;margin:0 auto 10px}
    .row{display:flex;gap:10px}
    input,select,textarea{width:100%;padding:10px;border:1px solid #d9dee7;border-radius:8px}
    .pdf{width:100%;height:600px;border:1px solid #e6e8ee;border-radius:10px}
    .tabs{display:flex;gap:8px;margin:6px 0 12px}
    .tab{background:#fff;border:1px solid #e6e8ee;border-radius:999px;padding:6px 12px;cursor:pointer}
    .tab.active{background:var(--primary-blue);color:#fff;border-color:var(--primary-blue)}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:16px}
    .modal.on{display:flex}
    .modal .panel{background:#fff;border-radius:12px;max-width:900px;width:100%;max-height:90vh;overflow:auto;padding:16px}
    .signature-pad{border:2px solid var(--primary-blue);border-radius:8px;background:#fff;width:100%;height:200px}
    .note{position:fixed;right:16px;top:16px;background:var(--ok);color:#fff;padding:10px 14px;border-radius:10px;box-shadow:var(--shadow);transform:translateX(400px);transition:transform .3s;z-index:1000}
    .note.error{background:var(--danger)} .note.show{transform:translateX(0)}
    @media (max-width:900px){.grid{grid-template-columns:1fr}.stats{grid-template-columns:repeat(2,1fr)}}
  </style>
</head>
<body>

  <!-- Login -->
  <div id="login" class="login">
    <div class="card center">
      <img class="logoTop" src="MRE-Bulb-Icon-RGB-FullColor-0518-01-152x152-8200955.jpg" alt="Mr. Electric" />
      <h2 style="text-align:center;margin-bottom:6px;color:var(--primary-blue)">Mr. Electric¬Æ SOP Tracker</h2>
      <p class="muted" style="text-align:center;margin-bottom:14px">a neighborly¬Æ company</p>
      <form onsubmit="return handleLogin(event)">
        <div style="display:grid;gap:10px">
          <input id="loginEmail" type="email" placeholder="user@mrelectric.com" required />
          <input id="loginPass" type="password" placeholder="Password" required />
          <button type="submit">Sign In</button>
          <button type="button" class="secondary" onclick="showRegister()">Create Account</button>
          <div id="loginErr" class="muted" style="color:var(--danger);display:none"></div>
        </div>
      </form>
    </div>
  </div>

  <!-- Register -->
  <div id="register" class="login" style="display:none">
    <div class="card center">
      <img class="logoTop" src="MRE-Bulb-Icon-RGB-FullColor-0518-01-152x152-8200955.jpg" alt="Mr. Electric" />
      <h2 style="text-align:center;margin-bottom:10px">Create Account</h2>
      <form onsubmit="return handleRegistration(event)">
        <div style="display:grid;gap:10px">
          <input id="regName" type="text" placeholder="Full name" required />
          <input id="regEmail" type="email" placeholder="user@mrelectric.com" required />
          <input id="regPass" type="password" placeholder="Password (min 6)" minlength="6" required />
          <select id="regRole">
            <option value="technician">Technician</option>
            <option value="supervisor">Supervisor</option>
            <option value="manager">Manager</option>
            <option value="admin">Administrator</option>
          </select>
          <button type="submit">Create Account</button>
          <button type="button" class="secondary" onclick="showLogin()">Back to Login</button>
        </div>
      </form>
    </div>
  </div>

  <!-- App -->
  <div id="app" class="screen" style="display:none">
    <div class="wrap">
      <div class="header">
        <div class="hrow">
          <img class="logo" src="MRE-Bulb-Icon-RGB-FullColor-0518-01-152x152-8200955.jpg" alt="logo" />
          <div>
            <h1>Mr. Electric SOP Tracker</h1>
            <div class="muted" id="subtitle">Standard Operating Procedure Management</div>
          </div>
          <div class="spacer"></div>
          <div class="muted" id="who">User</div>
          <button onclick="logout()">Logout</button>
        </div>
      </div>

      <div class="stats">
        <div class="stat"><div class="num" id="tSops">0</div><div class="muted">Total SOPs</div></div>
        <div class="stat"><div class="num" id="tPending">0</div><div class="muted">Pending</div></div>
        <div class="stat"><div class="num" id="tDone">0</div><div class="muted">Completed</div></div>
        <div class="stat"><div class="num" id="tRate">0%</div><div class="muted">Compliance</div></div>
      </div>

      <div class="grid" style="margin-top:12px">
        <div class="card">
          <h2><div class="card-icon">üìÑ</div> Upload & Manage SOPs</h2>
          <div style="display:grid;gap:10px">
            <div class="row">
              <input id="file" type="file" accept=".pdf,.txt,.doc,.docx" />
              <button onclick="uploadSOP()">Upload</button>
            </div>
            <button class="secondary" onclick="openCreate()">‚úèÔ∏è Create Manual SOP</button>
          </div>
        </div>

        <div class="card">
          <h2><div class="card-icon">üë•</div> User Management</h2>
          <div class="muted">Registration is self-serve. Promote users to admin in Firestore if needed.</div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h2><div class="card-icon">üìã</div> SOP Management Dashboard</h2>
        <div class="tabs">
          <div id="tabAll" class="tab active" onclick="setFilter('all', this)">All</div>
          <div id="tabActive" class="tab" onclick="setFilter('active', this)">Active</div>
          <div id="tabRevoked" class="tab" onclick="setFilter('revoked', this)">Revoked</div>
        </div>
        <div id="sopList" class="list"></div>
      </div>
    </div>
  </div>

  <!-- Create SOP Modal -->
  <div id="modalCreate" class="modal"><div class="panel">
    <h3 style="margin:6px 0 12px">Create Manual SOP</h3>
    <div class="row"><input id="mTitle" placeholder="SOP title" /></div>
    <div class="row">
      <input id="mVersion" placeholder="1.0" value="1.0" />
      <select id="mDept">
        <option value="all">All</option><option value="electrical">Electrical</option>
        <option value="safety">Safety</option><option value="maintenance">Maintenance</option>
        <option value="quality">Quality Control</option><option value="operations">Operations</option>
      </select>
    </div>
    <div class="row">
      <input id="mDue" type="date" />
      <select id="mPriority">
        <option value="normal">Normal</option><option value="high">High</option><option value="urgent">Urgent</option>
      </select>
    </div>
    <textarea id="mBody" rows="8" placeholder="Enter SOP content..."></textarea>
    <div class="row" style="margin-top:10px">
      <button onclick="createManual()">Create</button>
      <button class="secondary" onclick="closeCreate()">Cancel</button>
    </div>
  </div></div>

  <!-- View SOP + Sign -->
  <div id="modalView" class="modal"><div class="panel">
    <h3 id="vTitle" style="margin:6px 0 12px">SOP</h3>
    <div id="vMeta" class="muted" style="margin-bottom:10px"></div>
    <div id="vBody"></div>
    <div id="vPDFWrap" style="display:none;margin:10px 0"><iframe id="vPDF" class="pdf"></iframe></div>
    <div id="sigBlock" style="display:none;margin-top:10px">
      <h3>Digital Signature</h3>
      <p class="muted">Sign to acknowledge you have read and understood this SOP.</p>
      <canvas id="sig" class="signature-pad"></canvas>
      <div class="row" style="margin-top:10px">
        <button class="secondary" onclick="clearSig()">Clear</button>
        <button onclick="saveSig()">Submit Signature</button>
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <button class="secondary" onclick="closeView()">Close</button>
    </div>
  </div></div>

  <div id="note" class="note"></div>

  <!-- Firebase (FREE) -->
  <script type="module">
    /* ===== Firebase CDN imports ===== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, addDoc, getDocs, collection, query, where, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";

    /* ===== Replace with your Firebase config (Spark plan is free) ===== */
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    /* ===== Init ===== */
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    /* ===== UI helpers ===== */
    const $ = (id)=>document.getElementById(id);
    function note(msg, error=false){ const el=$('note'); el.textContent=msg; el.className='note'+(error?' error':'')+' show'; setTimeout(()=>el.classList.remove('show'),2500); }

    /* ===== Auth flows ===== */
    window.handleLogin = async (e)=>{
      e.preventDefault();
      try{
        await signInWithEmailAndPassword(auth, $('loginEmail').value, $('loginPass').value);
        $('loginErr').style.display='none';
      }catch(err){
        $('loginErr').textContent = "Invalid email or password";
        $('loginErr').style.display = 'block';
      }
    };
    window.handleRegistration = async (e)=>{
      e.preventDefault();
      const name=$('regName').value, email=$('regEmail').value, pass=$('regPass').value, role=$('regRole').value;
      try{
        const { user } = await createUserWithEmailAndPassword(auth, email, pass);
        await updateProfile(user,{ displayName:name });
        await setDoc(doc(db,'users',user.uid),{ name, email, role, createdAt:new Date().toISOString() });
        note('Account created! Please sign in.'); showLogin();
      }catch(err){ note(err.message,true); }
    };
    window.logout = ()=>signOut(auth);

    function showLogin(){ $('register').style.display='none'; $('login').style.display='flex'; }
    function showRegister(){ $('login').style.display='none'; $('register').style.display='flex'; }

    onAuthStateChanged(auth, async (user)=>{
      if(user){
        $('login').style.display='none'; $('register').style.display='none'; $('app').style.display='block';
        const prof = await getDoc(doc(db,'users',user.uid));
        const role = prof.exists()? prof.data().role : 'technician';
        $('who').textContent = `${user.displayName||'User'} ‚Ä¢ ${role}`;
        currentUser = { id:user.uid, name:user.displayName||'User', role, email:user.email };
        await refreshAll();
      }else{
        $('app').style.display='none'; showLogin();
      }
    });

    /* ===== Data ===== */
    let currentUser = null;
    let cacheSOPs = [];
    let filter = 'all';

    async function refreshAll(){
      // pull SOPs & signatures
      const sopSnap = await getDocs(query(collection(db,'sops'), orderBy('uploadDate','desc')));
      cacheSOPs = sopSnap.docs.map(d=>({id:d.id, ...d.data()}));

      const usersSnap = await getDocs(collection(db,'users'));
      const users = usersSnap.docs.map(d=>({id:d.id, ...d.data()}));

      const sigSnap = await getDocs(collection(db,'signatures'));
      const signatures = sigSnap.docs.map(d=>({id:d.id, ...d.data()}));

      // stats
      const activeCount = cacheSOPs.filter(s=>s.status==='active').length;
      $('tSops').textContent = activeCount;
      const totalRequired = activeCount * users.length;
      const completed = signatures.length;
      $('tDone').textContent = completed;
      $('tPending').textContent = Math.max(0, totalRequired - completed);
      $('tRate').textContent = totalRequired>0 ? Math.round((completed/totalRequired)*100)+'%' : '0%';

      renderSOPList();
    }

    function renderSOPList(){
      const list = $('sopList'); list.innerHTML='';
      const mineSignedIds = new Set(); // we‚Äôll fill lazily if needed
      const items = cacheSOPs.filter(s=> filter==='all' ? true : s.status===filter);
      if(items.length===0){ list.innerHTML = `<div class="muted" style="text-align:center;padding:30px">No SOPs</div>`; return; }

      items.forEach(sop=>{
        const wrap = document.createElement('div');
        wrap.className='item';
        const when = new Date(sop.uploadDate).toLocaleDateString();
        wrap.innerHTML = `
          <div style="min-width:0">
            <div style="font-weight:600">${sop.title}</div>
            <div class="muted">v${sop.version} ‚Ä¢ ${sop.department} ‚Ä¢ ${when} ${sop.dueDate?`‚Ä¢ Due: ${new Date(sop.dueDate).toLocaleDateString()}`:''} ${sop.isPDF?'‚Ä¢ PDF':''}</div>
          </div>
          <div class="row">
            <span class="badge ${sop.status==='active'?'active':'revoked'}">${sop.status}</span>
            <button class="secondary" onclick="openView('${sop.id}')">View</button>
            ${sop.status==='active'
              ? `<button class="secondary" onclick="revokeSOP('${sop.id}')">Revoke</button>`
              : `<button class="secondary" onclick="activateSOP('${sop.id}')">Activate</button>`}
            <button class="danger" onclick="deleteSOP('${sop.id}')">Delete</button>
          </div>`;
        list.appendChild(wrap);
      });
    }

    /* ===== SOP CRUD ===== */
    window.setFilter = (name, el)=>{
      filter = name;
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      el.classList.add('active');
      renderSOPList();
    };

    // Upload file (PDF -> Storage, text -> Firestore)
    window.uploadSOP = async ()=>{
      const file = $('file').files[0];
      if(!file) return note('Choose a file', true);
      const base = file.name.replace(/\.[^/.]+$/,'');
      const sop = {
        title: base, version:'1.0', department:'all', status:'active',
        uploadDate:new Date().toISOString(), uploadedBy: currentUser.id, uploadedByName: currentUser.name,
        dueDate:null, priority:'normal', fileName:file.name, fileType:file.type, isPDF: file.type==='application/pdf'
      };

      if(sop.isPDF){
        // upload to Storage
        const id = crypto.randomUUID();
        const path = `sops/${id}.pdf`;
        await uploadBytes(ref(storage, path), file);
        const url = await getDownloadURL(ref(storage, path));
        sop.storagePath = path; sop.pdfURL = url; sop.content = ''; // content in storage
        await setDoc(doc(db,'sops', id), sop);
      }else{
        // read text, store in Firestore doc
        const text = await file.text();
        sop.content = text; sop.pdfURL = ''; sop.storagePath='';
        await addDoc(collection(db,'sops'), sop);
      }
      $('file').value='';
      note('SOP uploaded!');
      await refreshAll();
    };

    // Manual Create
    function openCreate(){ $('modalCreate').classList.add('on'); }
    function closeCreate(){ $('modalCreate').classList.remove('on'); }
    window.openCreate = openCreate; window.closeCreate = closeCreate;

    window.createManual = async ()=>{
      const title=$('mTitle').value.trim(), version=$('mVersion').value||'1.0', department=$('mDept').value;
      const dueDate=$('mDue').value||null, priority=$('mPriority').value, content=$('mBody').value.trim();
      if(!title || !content){ return note('Enter title & content', true); }
      await addDoc(collection(db,'sops'), {
        title, version, department, status:'active', uploadDate:new Date().toISOString(),
        uploadedBy: currentUser.id, uploadedByName: currentUser.name, dueDate, priority,
        content, fileName:'manual_entry', fileType:'text/plain', isPDF:false, pdfURL:'', storagePath:''
      });
      $('mTitle').value=''; $('mVersion').value='1.0'; $('mBody').value=''; $('mDue').value='';
      closeCreate(); note('SOP created!'); await refreshAll();
    };

    window.revokeSOP = async (id)=>{ await updateDoc(doc(db,'sops',id), { status:'revoked' }); note('SOP revoked'); await refreshAll(); };
    window.activateSOP = async (id)=>{ await updateDoc(doc(db,'sops',id), { status:'active' }); note('SOP activated'); await refreshAll(); };
    window.deleteSOP = async (id)=>{
      if(!confirm('Delete this SOP?')) return;
      await deleteDoc(doc(db,'sops',id)); note('SOP deleted'); await refreshAll();
    };

    /* ===== View + Sign ===== */
    let viewSopId = null;
    function openView(id){ viewSopId = id; renderView(); $('modalView').classList.add('on'); }
    function closeView(){ $('modalView').classList.remove('on'); viewSopId=null; }
    window.openView = openView; window.closeView = closeView;

    async function renderView(){
      const sop = cacheSOPs.find(s=>s.id===viewSopId); if(!sop) return;
      $('vTitle').textContent = sop.title;
      $('vMeta').innerHTML = `v${sop.version} ‚Ä¢ ${sop.department} ‚Ä¢ ${new Date(sop.uploadDate).toLocaleDateString()} ${sop.dueDate?`‚Ä¢ Due: ${new Date(sop.dueDate).toLocaleDateString()}`:''} ‚Ä¢ Status: ${sop.status}`;

      if(sop.isPDF && sop.pdfURL){
        $('vPDFWrap').style.display='block'; $('vPDF').src = sop.pdfURL;
        $('vBody').innerHTML = '';
      }else{
        $('vPDFWrap').style.display='none';
        $('vBody').innerHTML = `<div style="background:#fff;border:1px solid #e6e8ee;border-radius:10px;padding:14px;white-space:pre-wrap">${sop.content||'No content'}</div>`;
      }

      // show signature pad if active + user hasn‚Äôt signed
      const mySigQ = query(collection(db,'signatures'), where('sopId','==',sop.id), where('userId','==',currentUser.id));
      const mySigSnap = await getDocs(mySigQ);
      const already = !mySigSnap.empty;
      $('sigBlock').style.display = (sop.status==='active' && !already) ? 'block' : 'none';
      setupSigPad();
    }

    // Signature pad
    let sigCtx=null, drawing=false;
    function setupSigPad(){
      const canvas = $('sig'); if(!canvas) return;
      const dpr = window.devicePixelRatio || 1;
      canvas.width = canvas.clientWidth * dpr; canvas.height = canvas.clientHeight * dpr;
      sigCtx = canvas.getContext('2d'); sigCtx.scale(dpr,dpr); sigCtx.lineWidth=2; sigCtx.lineCap='round'; sigCtx.strokeStyle='#000';
      canvas.onmousedown = (e)=>{ drawing=true; sigCtx.beginPath(); sigCtx.moveTo(e.offsetX,e.offsetY); };
      canvas.onmousemove = (e)=>{ if(drawing){ sigCtx.lineTo(e.offsetX,e.offsetY); sigCtx.stroke(); } };
      window.onmouseup = ()=> drawing=false;
      canvas.ontouchstart = (e)=>{ e.preventDefault(); const t=e.touches[0], r=canvas.getBoundingClientRect(); drawing=true; sigCtx.beginPath(); sigCtx.moveTo(t.clientX-r.left, t.clientY-r.top); };
      canvas.ontouchmove = (e)=>{ e.preventDefault(); if(!drawing) return; const t=e.touches[0], r=canvas.getBoundingClientRect(); sigCtx.lineTo(t.clientX-r.left, t.clientY-r.top); sigCtx.stroke(); };
      canvas.ontouchend = ()=> drawing=false;
    }
    window.clearSig = ()=>{ const c=$('sig'); if(!c||!sigCtx) return; sigCtx.clearRect(0,0,c.width,c.height); };

    window.saveSig = async ()=>{
      const c=$('sig'); if(!c) return;
      const dataURL = c.toDataURL('image/png');
      // quick empty check: PNG header length minimal? also inspect pixels
      const isEmpty = dataURL.length < 2000; // rough guard
      if(isEmpty){ return note('Please sign before submitting', true); }
      const sopId = viewSopId;

      // upload image to Storage
      const path = `signatures/${sopId}/${currentUser.id}.png`;
      const blob = await (await fetch(dataURL)).blob();
      await uploadBytes(ref(storage, path), blob);
      const url = await getDownloadURL(ref(storage, path));

      // save record
      await addDoc(collection(db,'signatures'), {
        sopId, userId: currentUser.id, userName: currentUser.name,
        timestamp: new Date().toISOString(), url
      });

      note('Signature saved!');
      closeView(); await refreshAll();
    };

    /* ===== Create modal triggers (exposed) ===== */
    window.openCreate = openCreate; window.closeCreate = closeCreate;

  </script>
</body>
</html>
